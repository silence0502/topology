/**
 * MIT License
 * 
 * Copyright (c) 2018 nasa.wang
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react"),require("react-dom"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","react","react-dom","lodash"],e):e(t.topology_instance={},t.React,t.ReactDOM,t._)}(this,function(t,e,n,a){"use strict";a=a&&a.hasOwnProperty("default")?a.default:a;var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};var i=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><rect class="body"/><rect class="card"/><rect class="alarm"/><text class="label"/><text class="type"/></g>',defaults:a.defaultsDeep({type:"VIM",size:{width:180,height:30},attrs:{".":{magnet:!1},".label":{text:"","ref-x":.55,"ref-y":.25,"font-size":14,"text-anchor":"middle",fill:"#000"},".type":{text:"","ref-x":.05,"ref-y":.7,"font-size":14,"text-anchor":"left",fill:"#000"},".alarm":{refX:"100%",refX2:-16,refY:"100%",refY2:-16,width:15,height:15},".logo":{x:-1,y:-1,width:30,height:32,fill:"#00B388",rx:"5px",ry:"5px"},".body":{"ref-width":"100%","ref-height":"100%",rx:"5px",ry:"5px",stroke:"#00B388","stroke-width":2}}},joint.shapes.basic.Generic.prototype.defaults),initialize:function(){joint.shapes.basic.Generic.prototype.initialize.apply(this,arguments)}}),o=joint.dia.Link.extend({defaults:a.defaultsDeep({type:"Link",attrs:{".connection":{stroke:"#C6C9CA","stroke-width":1},".link-tools":{display:"none"},".marker-arrowheads":{display:"none"}},z:-1},joint.dia.Link.prototype.defaults),initialize:function(){joint.dia.Link.prototype.initialize.apply(this,arguments)}}),s=function(t){var e={attrs:{".connection":{stroke:"#C6C9CA","stroke-dasharray":""},".marker-target":{stroke:"#C6C9CA",fill:"#C6C9CA",d:"M 10 0 L 0 5 L 10 10 z"}},router:{name:"normal"},connector:{name:"normal"}};if(t){switch(e.state=t.state,e.source={id:t.source},e.target={id:t.target},t.state){case 0:e.attrs[".connection"].stroke="#C6C9CA",e.attrs[".connection"]["stroke-width"]=3,e.attrs[".marker-target"].fill="#C6C9CA",e.attrs[".marker-target"].stroke="#C6C9CA",e.router.name="manhattan";break;case 1:e.attrs[".connection"].stroke="#D10002",e.attrs[".marker-target"].fill="#fff",e.attrs[".connection"]["stroke-dasharray"]="5 3",e.attrs[".marker-target"].stroke="#D10002",e.connector.name="smooth";break;case 2:e.attrs[".connection"].stroke="#FF9901",e.attrs[".connection"]["stroke-dasharray"]="5 3",e.attrs[".marker-target"].fill="#FF9901",e.attrs[".marker-target"].stroke="#FF9901",e.connector.name="smooth";break;case 3:e.attrs[".connection"].stroke="#DFB202",e.attrs[".connection"]["stroke-dasharray"]="5 3",e.attrs[".marker-target"].fill="#DFB202",e.attrs[".marker-target"].stroke="#DFB202",e.connector.name="smooth";break;case 4:e.attrs[".connection"].stroke="#00BFFF",e.attrs[".connection"]["stroke-dasharray"]="5 3",e.attrs[".marker-target"].fill="#00BFFF",e.attrs[".marker-target"].stroke="#00BFFF",e.connector.name="smooth";break;default:e.attrs[".connection"].stroke="#C6C9CA",e.attrs[".connection"]["stroke-width"]=3,e.attrs[".marker-target"].fill="#C6C9CA",e.attrs[".marker-target"].stroke="#C6C9CA"}switch(t.type){case 4:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 z";break;case 1:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 L 20 5 z";break;case 2:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 L 20 5 z",e.attrs[".marker-target"].fill="#fff";break;case 3:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 L 0 5 z";break;case 0:e.attrs[".marker-target"].d="";break;default:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 z"}}return e};!function(t,e){function n(t){this.selfconf={btnClass:"active",element:document,fullscreenBtn:null};for(var e in this.selfconf)this.selfconf[e]=t[e]||this.selfconf[e];this.fullscreenBtnEvent(),this.statusChangeEvent()}n.prototype={isSupported:document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled,fullscreenedElement:function(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement},exitFullscreen:function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen?document.msExitFullscreen():this.selfconf.element.style.cssText=""},launchFullscreen:function(){var t=this.selfconf.element;t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.style.cssText="position:fixed;z-index:9999;width:100%;height:100%;top:0;left:0;"},fullscreenBtnEvent:function(){var t=this,e=t.selfconf.fullscreenBtn,n=t.selfconf.element,i=t.selfconf.btnClass;e&&(e.onclick=function(){a(e,i)?(r(e,i),t.exitFullscreen()):(a(o=e,s=i)||(o.className+=" "+s),t.launchFullscreen(n));var o,s})},statusChangeEvent:function(){var t=this,e=this.selfconf.fullscreenBtn,n=this.selfconf.element,a=this.selfconf.btnClass;t.isSupported&&(document.addEventListener("fullscreenchange",i),document.addEventListener("mozfullscreenchange",i),document.addEventListener("webkitfullscreenchange",i),document.addEventListener("msfullscreenchange",i)),document.onkeydown=function(t){27==((t=t||window.event).keyCode||t.which)&&(i(),n.style.cssText="")};function i(){t.fullscreenedElement()||r(e,a)}}};function a(t,e){return t&&t.className.match(new RegExp("(\\s|^)"+e+"(\\s|$)"))||!1}function r(t,e){if(a(t,e)){var n=new RegExp("(\\s|^)"+e+"(\\s|$)");t.className=t.className.replace(n," ")}}t.fullscreen=n}(window);var l=function(t){!function(t,e){r(t,e);function n(){this.constructor=t}t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(n,t);function n(e){var n=t.call(this,e)||this;return n.state={disabled:!1,visable_instance:!1},n}return n.prototype.doAnimate=function(){var t=this.graph,e=this.paper;t.on("signal",function(n,r){if(n instanceof joint.dia.Link){if(100===n.attributes.state){var i=t.getCell(n.get("target").id);e.findViewByModel(n).sendToken(V("circle",{r:7,fill:"green"}).node,1e3,function(){i.trigger("signal",i)})}}else{var o=t.getConnectedLinks(n,{outbound:!0});a.each(o,function(t){t.trigger("signal",t)})}});var n=[],r=[];a.map(t.getLinks(),function(t){n.push(t.get("source").id),r.push(t.get("target").id)});var i=a.sortedUniq(a.difference(n,r));setInterval(function(){a.map(i,function(e){var n=t.getCell(e);n.trigger("signal",n)})},3e3)},n.prototype.parseData=function(t,e){var n=this;t.nodes&&(a.map(t.nodes,function(t){var r={isHighlight:t.id===n.props.cid};new i(function(t){var e={size:{},attrs:{".label":{},".type":{},".alarm":{},".logo":{},".body":{}}},n="",a="xlink:href="+t.logo_y;if(t){switch(t.id&&(e.id=t.id),t.bizFields&&(e.bizFields=t.bizFields),t.label&&(n='data-tooltip="'+t.label+'"',e.markup='<g class="rotatable" '+n+'><rect class="body"/><rect class="logo" /><image '+a+' x="1" y="1" height="28px" width="28px"/><rect class="card"/><rect class="alarm"/><text class="label"/><text class="type"/></g>'),t.label&&t.label&&(t.label.length>8?e.attrs[".label"].text=t.label.substring(0,6)+"...":e.attrs[".label"].text=t.label),t.state){case 0:e.attrs[".alarm"].width=0,e.attrs[".alarm"].height=0;break;case 1:e.attrs[".alarm"].fill="#D10002";break;case 2:e.attrs[".alarm"].fill="#FF9901";break;case 3:e.attrs[".alarm"].fill="#DFB202";break;case 4:e.attrs[".alarm"].fill="#00BFFF";break;default:e.attrs[".alarm"].width=0,e.attrs[".alarm"].height=0}switch(t.state){case 0:e.attrs[".logo"].fill="#00B388",e.attrs[".body"].stroke="#00B388";break;case 1:case 2:case 3:case 4:e.attrs[".logo"].fill="#84756b",e.attrs[".body"].stroke="#84756b";break;default:e.attrs[".logo"].fill="#00B388",e.attrs[".body"].stroke="#00B388"}}return e}(a.merge(t,r,e))).addTo(n.graph)}),t.links&&a.map(t.links,function(t){new o(s(t)).addTo(n.graph)}))},n.prototype.initializePaper=function(){var t=this,e=this.graph=new joint.dia.Graph;this.commandManager=new joint.dia.CommandManager({graph:e});var n=this.paper=new joint.dia.Paper({width:this.props.paper_width,height:this.props.paper_height,gridSize:10,drawGrid:this.props.drawGrid,model:e,perpendicularLinks:!0,restrictTranslate:!0});this.parseData(this.props.data,this.props.images),this.props.animate&&this.doAnimate();var r=this.paperScroller=new joint.ui.PaperScroller({paper:n,autoResizePaper:!0,cursor:"grab"});n.on("blank:pointerdown",r.startPanning),$(this.paperContainer).append(r.el),this.renderLayout(),this.renderLinks_2(),r.render(),this.props.center&&r.center(),this.props.zoomToFit&&r.zoomToFit();new joint.ui.Tooltip({target:"[data-tooltip]",content:function(t){var e=a.split(t.attributes["data-tooltip"].nodeValue,"|");return a.map(a.split(t.attributes["data-tooltip"].nodeValue,"|"),function(t,n){return 0===n&&e.length>1?e[0]!==e[1]?"<b>"+t+"</b><hr />":"":t})}});n.on("cell:pointerdblclick",function(e){t.props.onDblclick&&t.props.onDblclick(e)}),n.on("cell:contextmenu",function(e){t.setState({disabled:!0})}),n.on("blank:pointerclick",function(e){t.setState({disabled:!1})}),n.on("blank:contextmenu",function(e){t.setState({disabled:!1})}),this.btn_map.onclick=this.small_map.bind(this),this.btn_zoomin.onclick=this.zoomIn.bind(this),this.btn_zoomout.onclick=this.zoomOut.bind(this),this.btn_fullscreen.onclick=this.full.bind(this)},n.prototype.initializeNavigator=function(){var t=this.navigator=new joint.ui.Navigator({width:240,height:115,paperScroller:this.paperScroller,zoom:!1});$(".navigator_instance").append(t.el),t.render()},n.prototype.small_map=function(){!0===this.state.visable_instance?this.setState({visable_instance:!1}):this.setState({visable_instance:!0})},n.prototype.function_1=function(){this.state.disabled},n.prototype.function_2=function(){this.state.disabled},n.prototype.function_3=function(){this.state.disabled},n.prototype.function_4=function(){this.state.disabled},n.prototype.renderLayout=function(){joint.layout.DirectedGraph.layout(this.graph,{nodeSep:50,edgeSep:80,marginX:100,marginY:100,rankSep:80,rankDir:"LR"})},n.prototype.renderLinks_2=function(){var t=this;this.props.data.links2&&a.map(this.props.data.links2,function(e){new o(s(e)).addTo(t.graph)})},n.prototype.zoomIn=function(){this.paperScroller.zoom(.2,{max:2})},n.prototype.zoomOut=function(){this.paperScroller.zoom(-.2,{min:.2})},n.prototype.full=function(){new fullscreen({element:document.getElementById("topology_instance"),fullscreenBtn:document.getElementById("btn-fullscreen")})},n.prototype.componentWillMount=function(){},n.prototype.componentDidMount=function(){this.initializePaper(),this.initializeNavigator(),this.full()},n.prototype.renderMap=function(){var t=this;return!0===this.state.visable_instance?e.createElement("div",{className:"navigator_instance",id:"navigator_instance",ref:function(e){t.navigator=e}}):e.createElement("div",{className:"navigator_instance",id:"navigator_instance",ref:function(e){t.navigator=e},style:{display:"none"}})},n.prototype.link_1=function(){},n.prototype.link_2=function(){},n.prototype.link_3=function(){},n.prototype.render=function(){var t=this;this.state.disabled;var n=!0===this.state.visable_instance?"关闭缩略图":"打开缩略图";return e.createElement("div",{className:"topology_instance",id:"topology_instance",style:{width:this.props.width,height:this.props.height}},e.createElement("div",{className:"topology-app"},e.createElement("div",{className:"app-body"},e.createElement("div",{ref:function(e){t.btn_map=e},id:"btn-map",className:"btn"},n),e.createElement("div",{ref:function(e){t.btn_zoomin=e},id:"btn-zoomin",className:"btn"},"+"),e.createElement("div",{ref:function(e){t.btn_zoomout=e},id:"btn-zoomout",className:"btn"},"-"),e.createElement("div",{ref:function(e){t.btn_fullscreen=e},id:"btn-fullscreen",className:"btn"},"全屏"),e.createElement("div",{className:"paper-container",ref:function(e){t.paperContainer=e}}),this.renderMap())))},n.defaultProps={animate:!0,width:800,height:600,paper_width:1e3,paper_height:1e3,drawGrid:!1,rankDir:"LR",data:{},images:{},center:!1,zoomToFit:!1},n}(e.Component);t.init=function(t,a){void 0===t&&(t="root"),n.render(e.createElement(l,{rankDir:a.rankDir,animate:a.animate,cid:a.cid,data:a.data,images:a.images,onDblclick:a.onDblclick,width:a.width,height:a.height}),document.getElementById(t))},t.TopologyInstance=l,Object.defineProperty(t,"__esModule",{value:!0})});
