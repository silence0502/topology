/**
 * MIT License
 * 
 * Copyright (c) 2018 nasa.wang
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react"),require("react-dom"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","react","react-dom","lodash"],e):e(t.topology_instance={},t.React,t.ReactDOM,t._)}(this,function(t,e,a,n){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n;var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])};var r=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><rect class="body"/><rect class="card"/><rect class="alarm"/><text class="label"/><text class="type"/></g>',defaults:n.defaultsDeep({type:"VIM",size:{width:180,height:30},attrs:{".":{magnet:!1},".label":{text:"","ref-x":.55,"ref-y":.25,"font-size":14,"text-anchor":"middle",fill:"#000"},".type":{text:"","ref-x":.05,"ref-y":.7,"font-size":14,"text-anchor":"left",fill:"#000"},".alarm":{refX:"100%",refX2:-16,refY:"100%",refY2:-16,width:15,height:15},".logo":{x:-1,y:-1,width:30,height:32,fill:"#00B388",rx:"5px",ry:"5px"},".body":{"ref-width":"100%","ref-height":"100%",rx:"5px",ry:"5px",stroke:"#00B388","stroke-width":2}}},joint.shapes.basic.Generic.prototype.defaults),initialize:function(){joint.shapes.basic.Generic.prototype.initialize.apply(this,arguments)}}),o=joint.dia.Link.extend({defaults:n.defaultsDeep({type:"Link",attrs:{".connection":{stroke:"#C6C9CA","stroke-width":1},".link-tools":{display:"none"},".marker-arrowheads":{display:"none"}},z:-1},joint.dia.Link.prototype.defaults),initialize:function(){joint.dia.Link.prototype.initialize.apply(this,arguments)}}),s=function(t){var e={attrs:{".connection":{stroke:"#C6C9CA","stroke-dasharray":""},".marker-target":{stroke:"#C6C9CA",fill:"#C6C9CA",d:"M 10 0 L 0 5 L 10 10 z"}},router:{name:"normal"},connector:{name:"normal"}};if(t){switch(e.state=t.state,e.source={id:t.source},e.target={id:t.target},t.state){case 0:e.attrs[".connection"].stroke="#C6C9CA",e.attrs[".connection"]["stroke-width"]=3,e.attrs[".marker-target"].fill="#C6C9CA",e.attrs[".marker-target"].stroke="#C6C9CA",e.router.name="manhattan";break;case 1:e.attrs[".connection"].stroke="#D10002",e.attrs[".marker-target"].fill="#fff",e.attrs[".connection"]["stroke-dasharray"]="5 3",e.attrs[".marker-target"].stroke="#D10002",e.connector.name="smooth";break;case 2:e.attrs[".connection"].stroke="#FF9901",e.attrs[".connection"]["stroke-dasharray"]="5 3",e.attrs[".marker-target"].fill="#FF9901",e.attrs[".marker-target"].stroke="#FF9901",e.connector.name="smooth";break;case 3:e.attrs[".connection"].stroke="#DFB202",e.attrs[".connection"]["stroke-dasharray"]="5 3",e.attrs[".marker-target"].fill="#DFB202",e.attrs[".marker-target"].stroke="#DFB202",e.connector.name="smooth";break;case 4:e.attrs[".connection"].stroke="#00BFFF",e.attrs[".connection"]["stroke-dasharray"]="5 3",e.attrs[".marker-target"].fill="#00BFFF",e.attrs[".marker-target"].stroke="#00BFFF",e.connector.name="smooth";break;default:e.attrs[".connection"].stroke="#C6C9CA",e.attrs[".connection"]["stroke-width"]=3,e.attrs[".marker-target"].fill="#C6C9CA",e.attrs[".marker-target"].stroke="#C6C9CA"}switch(t.type){case 4:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 z";break;case 1:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 L 20 5 z";break;case 2:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 L 20 5 z",e.attrs[".marker-target"].fill="#fff";break;case 3:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 L 0 5 z";break;case 0:e.attrs[".marker-target"].d="";break;default:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 z"}}return e},l=function(t){!function(t,e){i(t,e);function a(){this.constructor=t}t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}(a,t);function a(e){var a=t.call(this,e)||this;return a.state={disabled:!1,visable_instance:!1},a}return a.prototype.doAnimate=function(){var t=this.graph,e=this.paper;t.on("signal",function(a,i){if(a instanceof joint.dia.Link){if(100==a.attributes.state){var r=t.getCell(a.get("target").id);e.findViewByModel(a).sendToken(V("circle",{r:7,fill:"green"}).node,1e3,function(){r.trigger("signal",r)})}}else{var o=t.getConnectedLinks(a,{outbound:!0});n.each(o,function(t){t.trigger("signal",t)})}});var a=[],i=[];n.map(t.getLinks(),function(t){a.push(t.get("source").id),i.push(t.get("target").id)});var r=n.sortedUniq(n.difference(a,i));setInterval(function(){n.map(r,function(e){var a=t.getCell(e);a.trigger("signal",a)})},3e3)},a.prototype.parseData=function(t,e){var a=this;t.nodes&&(n.map(t.nodes,function(t){var i={isHighlight:t.id===a.props.cid};new r(function(t){var e={size:{},attrs:{".label":{},".type":{},".alarm":{},".logo":{},".body":{}}},a="",n="xlink:href="+t.logo_y;if(t){switch(t.id&&(e.id=t.id),t.bizFields&&(e.bizFields=t.bizFields),t.label&&(a='data-tooltip="'+t.label+'"',e.markup='<g class="rotatable" '+a+'><rect class="body"/><rect class="logo" /><image '+n+' x="1" y="1" height="28px" width="28px"/><rect class="card"/><rect class="alarm"/><text class="label"/><text class="type"/></g>'),t.label&&t.label&&(t.label.length>8?e.attrs[".label"].text=t.label.substring(0,6)+"...":e.attrs[".label"].text=t.label),t.state){case 0:e.attrs[".alarm"].width=0,e.attrs[".alarm"].height=0;break;case 1:e.attrs[".alarm"].fill="#D10002";break;case 2:e.attrs[".alarm"].fill="#FF9901";break;case 3:e.attrs[".alarm"].fill="#DFB202";break;case 4:e.attrs[".alarm"].fill="#00BFFF";break;default:e.attrs[".alarm"].width=0,e.attrs[".alarm"].height=0}switch(t.state){case 0:e.attrs[".logo"].fill="#00B388",e.attrs[".body"].stroke="#00B388";break;case 1:case 2:case 3:case 4:e.attrs[".logo"].fill="#84756b",e.attrs[".body"].stroke="#84756b";break;default:e.attrs[".logo"].fill="#00B388",e.attrs[".body"].stroke="#00B388"}}return e}(n.merge(t,i,e))).addTo(a.graph)}),t.links&&n.map(t.links,function(t){new o(s(t)).addTo(a.graph)}))},a.prototype.initializePaper=function(){var t=this,e=this.graph=new joint.dia.Graph;this.commandManager=new joint.dia.CommandManager({graph:e});var a=this.paper=new joint.dia.Paper({width:this.props.paper_width,height:this.props.paper_height,gridSize:10,drawGrid:this.props.drawGrid,model:e,perpendicularLinks:!0,restrictTranslate:!0});this.parseData(this.props.data,this.props.images),this.props.animate&&this.doAnimate();var i=this.paperScroller=new joint.ui.PaperScroller({paper:a,autoResizePaper:!0,cursor:"grab"});a.on("blank:pointerdown",i.startPanning),$(this.paperContainer).append(i.el),this.renderLayout(),this.renderLinks_2(),i.render(),this.props.center&&i.center(),this.props.zoomToFit&&i.zoomToFit(),new joint.ui.Tooltip({target:"[data-tooltip]",content:function(t){var e=n.split(t.attributes["data-tooltip"].nodeValue,"|");return n.map(n.split(t.attributes["data-tooltip"].nodeValue,"|"),function(t,a){return 0==a&&e.length>1?e[0]!=e[1]?"<b>"+t+"</b><hr />":"":t})}}),a.on("cell:pointerdblclick",function(e){t.props.onDblclick&&t.props.onDblclick(e)}),a.on("cell:contextmenu",function(e){t.setState({disabled:!0})}),a.on("blank:pointerclick",function(e){t.setState({disabled:!1})}),a.on("blank:contextmenu",function(e){t.setState({disabled:!1})}),this.btn_function_1.onclick=this.function_1.bind(this),this.btn_function_2.onclick=this.function_2.bind(this),this.btn_function_3.onclick=this.function_3.bind(this),this.btn_function_4.onclick=this.function_4.bind(this),this.btn_map.onclick=this.small_map.bind(this),this.btn_zoomin.onclick=this.zoomIn.bind(this),this.btn_zoomout.onclick=this.zoomOut.bind(this)},a.prototype.initializeNavigator=function(){var t=this.navigator=new joint.ui.Navigator({width:240,height:115,paperScroller:this.paperScroller,zoom:!1});$(".navigator_instance").append(t.el),t.render()},a.prototype.small_map=function(){!0===this.state.visable_instance?this.setState({visable_instance:!1}):this.setState({visable_instance:!0})},a.prototype.function_1=function(){1==this.state.disabled&&console.log("--------------------------------------------------\x3efunction_1")},a.prototype.function_2=function(){1==this.state.disabled&&console.log("--------------------------------------------------\x3efunction_2")},a.prototype.function_3=function(){1==this.state.disabled&&console.log("--------------------------------------------------\x3efunction_3")},a.prototype.function_4=function(){1==this.state.disabled&&console.log("--------------------------------------------------\x3efunction_4")},a.prototype.renderLayout=function(){joint.layout.DirectedGraph.layout(this.graph,{nodeSep:50,edgeSep:80,marginX:100,marginY:100,rankSep:80,rankDir:"LR"})},a.prototype.renderLinks_2=function(){var t=this;this.props.data.links_2&&n.map(this.props.data.links_2,function(e){new o(s(e)).addTo(t.graph)})},a.prototype.zoomIn=function(){this.paperScroller.zoom(.2,{max:2})},a.prototype.zoomOut=function(){this.paperScroller.zoom(-.2,{min:.2})},a.prototype.componentWillMount=function(){},a.prototype.componentDidMount=function(){this.initializePaper(),this.initializeNavigator()},a.prototype.renderMap=function(){var t=this;return!0===this.state.visable_instance?e.createElement("div",{className:"navigator_instance",id:"navigator_instance",ref:function(e){t.navigator=e}}):e.createElement("div",{className:"navigator_instance",id:"navigator_instance",ref:function(e){t.navigator=e},style:{display:"none"}})},a.prototype.link_1=function(){console.log("-----------------\x3elink-1")},a.prototype.link_2=function(){console.log("-----------------\x3elink-2")},a.prototype.link_3=function(){console.log("-----------------\x3elink-3")},a.prototype.render=function(){var t=this,a={},n="",i="",r="",o="",s={},l={};!1===this.state.disabled?(a={color:"rgba(0,0,0,.25)",backgroundColor:"#f5f5f5",borderColor:"#d9d9d9",cursor:"not-allowed"},n=i=r=o="请选中元件",s={cursor:"not-allowed"},l={display:"none"}):(n="功能1",i="功能2",r="功能3",o="功能4",s={cursor:"pointer"});var c=!0===this.state.visable_instance?"关闭缩略图":"打开缩略图";return e.createElement("div",{className:"topology_instance",style:{width:this.props.width,height:this.props.height}},e.createElement("div",{className:"topology-app"},e.createElement("div",{className:"app-body"},e.createElement("div",{className:"fun-btn-area"},e.createElement("div",{className:"fun-item"},e.createElement("div",{ref:function(e){t.btn_function_1=e},style:a,id:"btn-function-1",className:"fun-btn"},e.createElement("label",{"data-tooltip":n,"data-tooltip-position":"top",style:s},"功能1"))),e.createElement("div",{className:"fun-item"},e.createElement("div",{ref:function(e){t.btn_function_2=e},style:a,id:"btn-function-1",className:"fun-btn"},e.createElement("label",{"data-tooltip":i,"data-tooltip-position":"top",style:s},"功能2"))),e.createElement("div",{className:"fun-item"},e.createElement("div",{ref:function(e){t.btn_function_3=e},style:a,id:"btn-function-1",className:"fun-btn"},e.createElement("label",{"data-tooltip":r,"data-tooltip-position":"top",style:s},"功能3"))),e.createElement("div",{className:"fun-item"},e.createElement("div",{ref:function(e){t.btn_function_4=e},style:a,id:"btn-function-1",className:"fun-btn"},e.createElement("label",{"data-tooltip":o,"data-tooltip-position":"top",style:s},"功能4"))),e.createElement("div",{className:"fun-item-more"},e.createElement("div",{ref:function(e){t.btn_more=e},style:a,id:"btn-function-1",className:"fun-btn"},"更多"),e.createElement("div",{className:"dropdown-content",style:l},e.createElement("a",{href:"jacascript:;",onClick:this.link_1.bind(this)},"下拉菜单项 1"),e.createElement("a",{href:"jacascript:;",onClick:this.link_2.bind(this)},"下拉菜单项 2"),e.createElement("a",{href:"jacascript:;",onClick:this.link_3.bind(this)},"下拉菜单项 3")))),e.createElement("div",{ref:function(e){t.btn_map=e},id:"btn-map",className:"btn"},c),e.createElement("div",{ref:function(e){t.btn_zoomin=e},id:"btn-zoomin",className:"btn"},"+"),e.createElement("div",{ref:function(e){t.btn_zoomout=e},id:"btn-zoomout",className:"btn"},"-"),e.createElement("div",{className:"paper-container",ref:function(e){t.paperContainer=e}}),this.renderMap())))},a.defaultProps={animate:!0,width:800,height:600,paper_width:1e3,paper_height:1e3,drawGrid:!1,rankDir:"LR",data:{},images:{},center:!1,zoomToFit:!1},a}(e.Component);t.init=function(t,n){void 0===t&&(t="root"),a.render(e.createElement(l,{rankDir:n.rankDir,animate:n.animate,cid:n.cid,data:n.data,images:n.images,onDblclick:n.onDblclick,width:n.width,height:n.height}),document.getElementById(t))},t.TopologyInstance=l,Object.defineProperty(t,"__esModule",{value:!0})});
