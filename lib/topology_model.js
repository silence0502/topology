/**
 * MIT License
 * 
 * Copyright (c) 2018 nasa.wang
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react"),require("react-dom"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","react","react-dom","lodash"],e):e(t.topology_model={},t.React,t.ReactDOM,t._)}(this,function(t,e,a,i){"use strict";i=i&&i.hasOwnProperty("default")?i.default:i;var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])};var r=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><rect class="body"/><rect class="card"/><rect class="alarm"/><text class="label"/><text class="type"/></g>',defaults:i.defaultsDeep({type:"VIM",size:{width:180,height:30},attrs:{".":{magnet:!1},".label":{text:"","ref-x":.55,"ref-y":.25,"font-size":14,"text-anchor":"middle",fill:"#000"},".type":{text:"","ref-x":.05,"ref-y":.7,"font-size":14,"text-anchor":"left",fill:"#000"},".alarm":{refX:"100%",refX2:-10,refY:"100%",refY2:-10,width:10,height:10},".body":{"ref-width":"100%","ref-height":"100%",rx:"10px",ry:"10px",stroke:"#00B388","stroke-width":2}}},joint.shapes.basic.Generic.prototype.defaults),initialize:function(){joint.shapes.basic.Generic.prototype.initialize.apply(this,arguments)}}),o=joint.dia.Link.extend({defaults:i.defaultsDeep({type:"Link",attrs:{".connection":{stroke:"#C6C9CA","stroke-width":3},".link-tools":{display:"none"},".marker-arrowheads":{display:"none"}},z:-1},joint.dia.Link.prototype.defaults),initialize:function(){joint.dia.Link.prototype.initialize.apply(this,arguments)}}),s=function(t){!function(t,e){n(t,e);function a(){this.constructor=t}t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}(a,t);function a(e){var a=t.call(this,e)||this;return a.state={disabled:!1,visable_model:!1},a}return a.prototype.doAnimate=function(){var t=this.graph,e=this.paper;t.on("signal",function(a,n){if(a instanceof joint.dia.Link){if(1e3==a.attributes.state){var r=t.getCell(a.get("target").id);e.findViewByModel(a).sendToken(V("circle",{r:7,fill:"green"}).node,1e3,function(){r.trigger("signal",r)})}}else{var o=t.getConnectedLinks(a,{outbound:!0});i.each(o,function(t){t.trigger("signal",t)})}});var a=[],n=[];i.map(t.getLinks(),function(t){a.push(t.get("source").id),n.push(t.get("target").id)});var r=i.sortedUniq(i.difference(a,n));setInterval(function(){i.map(r,function(e){var a=t.getCell(e);a.trigger("signal",a)})},3e3)},a.prototype.parseData=function(t,e){var a=this;t.nodes&&(i.map(t.nodes,function(t){var n={isHighlight:t.id===a.props.cid};new r(function(t){var e={size:{},attrs:{".label":{},".type":{},".alarm":{},".body":{}}},a="",i="";if(t){if(t.id&&(e.id=t.id),t.bizFields&&(e.bizFields=t.bizFields),t.label){switch(a='data-tooltip="'+t.label+'"',t.type){case"switch":i="xlink:href="+t.switch;break;case"vm":i="xlink:href="+t.vm;break;case"vnf":i="xlink:href="+t.vnf;break;case"vnfc":i="xlink:href="+t.vnfc;break;case"server":i="xlink:href="+t.server;break;default:i="xlink:href="+t.switch}e.markup='<g class="rotatable" '+a+'><rect class="body"/><image '+i+' x="1" y="1" height="28px" width="28px"/><rect class="card"/><text class="label"/><text class="type"/></g>'}t.label&&t.label&&(t.label.length>8?e.attrs[".label"].text=t.label.substring(0,6)+"...":e.attrs[".label"].text=t.label)}return e}(i.merge(t,n,e))).addTo(a.graph)}),t.links&&i.map(t.links,function(t){new o(function(t){var e={attrs:{".connection":{stroke:"#C6C9CA","stroke-dasharray":""},".marker-target":{stroke:"#C6C9CA",fill:"#C6C9CA",d:"M 10 0 L 0 5 L 10 10 z"}}};if(t){switch(e.state=t.state,e.source={id:t.source},e.target={id:t.target},t.state){case 0:e.attrs[".connection"].stroke="#C6C9CA",e.attrs[".marker-target"].fill="#C6C9CA",e.attrs[".marker-target"].stroke="#C6C9CA";break;case 1:e.attrs[".connection"].stroke="#D10002",e.attrs[".marker-target"].fill="#fff",e.attrs[".connection"]["stroke-dasharray"]="5 2",e.attrs[".marker-target"].stroke="#D10002";break;case 2:e.attrs[".connection"].stroke="#FF9901",e.attrs[".connection"]["stroke-dasharray"]="5 2",e.attrs[".marker-target"].fill="#FF9901",e.attrs[".marker-target"].stroke="#FF9901";break;case 3:e.attrs[".connection"].stroke="#DFB202",e.attrs[".connection"]["stroke-dasharray"]="5 2",e.attrs[".marker-target"].fill="#DFB202",e.attrs[".marker-target"].stroke="#DFB202";break;case 4:e.attrs[".connection"].stroke="#00BFFF",e.attrs[".connection"]["stroke-dasharray"]="5 2",e.attrs[".marker-target"].fill="#00BFFF",e.attrs[".marker-target"].stroke="#00BFFF";break;default:e.attrs[".connection"].stroke="#31d0c6",e.attrs[".connection"]["stroke-dasharray"]="5 2",e.attrs[".marker-target"].fill="#31d0c6",e.attrs[".marker-target"].stroke="#31d0c6"}switch(t.type){case 0:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 z";break;case 1:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 L 20 5 z";break;case 2:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 L 20 5 z",e.attrs[".marker-target"].fill="#fff";break;case 3:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 L 0 5 z";break;case 4:e.attrs[".marker-target"].d="";break;default:e.attrs[".marker-target"].d="M 10 0 L 0 5 L 10 10 z"}}return e}(t)).addTo(a.graph)}))},a.prototype.initializePaper=function(){var t=this,e=this.graph=new joint.dia.Graph;this.commandManager=new joint.dia.CommandManager({graph:e});var a=this.paper=new joint.dia.Paper({width:this.props.paper_width,height:this.props.paper_height,gridSize:10,drawGrid:this.props.drawGrid,model:e,perpendicularLinks:!0,restrictTranslate:!0});this.parseData(this.props.data,this.props.images),this.props.animate&&this.doAnimate();var n=this.paperScroller=new joint.ui.PaperScroller({paper:a,autoResizePaper:!0,cursor:"grab"});a.on("blank:pointerdown",n.startPanning),$(this.paperContainer).append(n.el),this.renderLayout(),n.render(),this.props.center&&n.center(),this.props.zoomToFit&&n.zoomToFit(),new joint.ui.Tooltip({target:"[data-tooltip]",content:function(t){var e=i.split(t.attributes["data-tooltip"].nodeValue,"|");return i.map(i.split(t.attributes["data-tooltip"].nodeValue,"|"),function(t,a){return 0==a&&e.length>1?e[0]!=e[1]?"<b>"+t+"</b><hr />":"":t})}}),a.on("cell:pointerdblclick",function(e){t.props.onDblclick&&t.props.onDblclick(e)}),a.on("cell:contextmenu",function(e){t.setState({disabled:!0})}),a.on("blank:pointerclick",function(e){t.setState({disabled:!1})}),a.on("blank:contextmenu",function(e){t.setState({disabled:!1})}),this.btn_function_1.onclick=this.function_1.bind(this),this.btn_function_2.onclick=this.function_2.bind(this),this.btn_function_3.onclick=this.function_3.bind(this),this.btn_function_4.onclick=this.function_4.bind(this),this.btn_map.onclick=this.small_map.bind(this),this.btn_zoomin.onclick=this.zoomIn.bind(this),this.btn_zoomout.onclick=this.zoomOut.bind(this)},a.prototype.initializeNavigator=function(){var t=this.navigator=new joint.ui.Navigator({width:240,height:115,paperScroller:this.paperScroller,zoom:!1});$(".navigator_model").append(t.el),t.render()},a.prototype.small_map=function(){!0===this.state.visable_model?this.setState({visable_model:!1}):this.setState({visable_model:!0})},a.prototype.function_1=function(){1==this.state.disabled&&console.log("--------------------------------------------------\x3efunction_1")},a.prototype.function_2=function(){1==this.state.disabled&&console.log("--------------------------------------------------\x3efunction_2")},a.prototype.function_3=function(){1==this.state.disabled&&console.log("--------------------------------------------------\x3efunction_3")},a.prototype.function_4=function(){1==this.state.disabled&&console.log("--------------------------------------------------\x3efunction_4")},a.prototype.renderLayout=function(){joint.layout.DirectedGraph.layout(this.graph,{nodeSep:50,edgeSep:80,marginX:100,marginY:100,rankDir:"TB"})},a.prototype.zoomIn=function(){this.paperScroller.zoom(.2,{max:2})},a.prototype.zoomOut=function(){this.paperScroller.zoom(-.2,{min:.2})},a.prototype.componentDidMount=function(){this.initializePaper(),this.initializeNavigator()},a.prototype.renderMap=function(){var t=this;return!0===this.state.visable_model?e.createElement("div",{className:"navigator_model",id:"navigator_model",ref:function(e){t.navigator=e}}):e.createElement("div",{className:"navigator_model",id:"navigator_model",ref:function(e){t.navigator=e},style:{display:"none"}})},a.prototype.link_1=function(){console.log("-----------------\x3elink-1")},a.prototype.link_2=function(){console.log("-----------------\x3elink-2")},a.prototype.link_3=function(){console.log("-----------------\x3elink-3")},a.prototype.render=function(){var t=this,a={},i="",n="",r="",o="",s={},l={};!1===this.state.disabled?(a={color:"rgba(0,0,0,.25)",backgroundColor:"#f5f5f5",borderColor:"#d9d9d9",cursor:"not-allowed"},i=n=r=o="请选中元件",s={cursor:"not-allowed"},l={display:"none"}):(i="功能1",n="功能2",r="功能3",o="功能4",s={cursor:"pointer"});var c=!0===this.state.visable_model?"关闭缩略图":"打开缩略图";return e.createElement("div",{className:"topology_model",style:{width:this.props.width,height:this.props.height}},e.createElement("div",{className:"topology-app"},e.createElement("div",{className:"app-body"},e.createElement("div",{className:"fun-btn-area"},e.createElement("div",{className:"fun-item"},e.createElement("div",{ref:function(e){t.btn_function_1=e},style:a,id:"btn-function-1",className:"fun-btn"},e.createElement("label",{"data-tooltip":i,"data-tooltip-position":"top",style:s},"功能1"))),e.createElement("div",{className:"fun-item"},e.createElement("div",{ref:function(e){t.btn_function_2=e},style:a,id:"btn-function-1",className:"fun-btn"},e.createElement("label",{"data-tooltip":n,"data-tooltip-position":"top",style:s},"功能2"))),e.createElement("div",{className:"fun-item"},e.createElement("div",{ref:function(e){t.btn_function_3=e},style:a,id:"btn-function-1",className:"fun-btn"},e.createElement("label",{"data-tooltip":r,"data-tooltip-position":"top",style:s},"功能3"))),e.createElement("div",{className:"fun-item"},e.createElement("div",{ref:function(e){t.btn_function_4=e},style:a,id:"btn-function-1",className:"fun-btn"},e.createElement("label",{"data-tooltip":o,"data-tooltip-position":"top",style:s},"功能4"))),e.createElement("div",{className:"fun-item-more"},e.createElement("div",{ref:function(e){t.btn_more=e},style:a,id:"btn-function-1",className:"fun-btn"},"更多"),e.createElement("div",{className:"dropdown-content",style:l},e.createElement("a",{href:"jacascript:;",onClick:this.link_1.bind(this)},"下拉菜单项 1"),e.createElement("a",{href:"jacascript:;",onClick:this.link_2.bind(this)},"下拉菜单项 2"),e.createElement("a",{href:"jacascript:;",onClick:this.link_3.bind(this)},"下拉菜单项 3")))),e.createElement("div",{ref:function(e){t.btn_map=e},id:"btn-map",className:"btn"},c),e.createElement("div",{ref:function(e){t.btn_zoomin=e},id:"btn-zoomin",className:"btn"},"+"),e.createElement("div",{ref:function(e){t.btn_zoomout=e},id:"btn-zoomout",className:"btn"},"-"),e.createElement("div",{className:"paper-container",ref:function(e){t.paperContainer=e}}),this.renderMap())))},a.defaultProps={animate:!0,width:800,height:600,paper_width:1e3,paper_height:1e3,drawGrid:!1,rankDir:"TB",data:{},images:{},center:!1,zoomToFit:!1},a}(e.Component);t.init=function(t,i){void 0===t&&(t="root"),a.render(e.createElement(s,{rankDir:i.rankDir,animate:i.animate,cid:i.cid,data:i.data,images:i.images,onDblclick:i.onDblclick,width:i.width,height:i.height}),document.getElementById(t))},t.TopologyModel=s,Object.defineProperty(t,"__esModule",{value:!0})});
